<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="utf-8">
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <title>Service</title>
 	<link rel="stylesheet" href="style.css.gz" />
<!-- <link href="nodemcu-css.css" rel="stylesheet">-->
 <script type="text/javascript" src="http://git.codedevice.ru/js/service.js"></script>
 <style>
  h3 {
   padding: 1rem;
  }

  p {
   margin: 0px;
  }

  .m-body {
   overflow: scroll;
   height: 300px;
   padding-top: 5px;
   border: 1px solid #a0a0a0;
   border-radius: 5px;
   margin: 15px 20px;
  }

  .m-head h3{
   margin: 0;
   padding: 0px 30px;
  }

  .warn {
   border-left: 5px solid #dc7272;
   padding: 10px;
   display: inherit;
   margin-bottom: 10px;
  }
 </style>
</head>

<body>
 <div id="loader" class="loader hide"></div>
 <div id="sideNav" class="sidenav">
  <span href="javascript:void(0)" class="close" onclick="document.getElementById('sideNav').classList.toggle('open');">&times;</span>
  <div class="in"></div>
  <a href="http://dot.codedevice.ru/example/" target="_blank">Example css</a>
  <a href="https://github.com/bondrogeen/dot" target="_blank">GitHub</a>
  <a href="http://dot.codedevice.ru" target="_blank">DOT</a>
 </div>
 <div class="sideopen warning"><a onclick="document.getElementById('sideNav').classList.toggle('open');">&equiv;</a></div>
 <ul class="nav fix warning" id="topNav">
  <li><a href="index.html" class="brand">DOT</a></li>
  <li><a href="settings.html">Settings</a></li>
  <li><a href="#" class="active">Service</a></li>
  <li class="-exit"><a href="#" id="btn_exit" onclick="logout()">Exit</a></li>
  <li class="-icon"><a href="#" onclick="document.getElementById('topNav').classList.toggle('res');">&equiv;</a></li>
 </ul>
 <div id="Modal" class="modal">
  <div class="m-cont">
   <div class="m-head">
      <span class="close" id="close_m" onclick="mClose()">&times;</span>
      <h3 class="m-info">Update</h3>
   </div>
   <div class="m-body">
    <p id="m-text"></p>
   </div>
   <div class="m-foo">
    <button id="start" class="info" onclick="startLoad('web-server');">Start</button>
    <button id="close" class="info" onclick="mClose();">Close</button>
    <button id="reboot" class="danger hide" onclick="reboot();">Reboot</button>
   </div>
  </div>
 </div>
 <div id="cont" class="cont">
  <div class="row">
   <div class="s12 of-m2 m10 of-l2 l8">
<!--
    <div class="row">
    <h3>Update.</h3>
     <div class="s12">
      <p>Updates of web server files via the Internet.</p>
      <span class="warn"><b>(!)</b> Attentions, web server files will be overwritten. </span>
      <button disabled class="info right" onclick="update();" id="btn_update">Update</button>
     </div>
    </div>
-->
    <h3>Plugins</h3>
    <div id="plugins" class="row">
    </div>
   </div>
  </div>
 </div>
 <script>
  function send(page, data, callback) {
   var req = new XMLHttpRequest();
   req.open("POST", page, true);
   req.setRequestHeader('Content-Type', 'application/json');
   req.addEventListener("load", function() {
    if (req.status < 400) {
     callback(req.responseText);
    } else {
     callback(false);
    }
   });
   req.send(JSON.stringify(data));
  }

  function id(n){
   return document.getElementById(n)
  }
  function loading(d,callback){
   var data = {};
   data.host = "git.codedevice.ru";
   data.port = 80;
   data.path = "/files/"+d+"/";
   data.file = "index.php";
   data.init = "upload";
   send("web_get.lua", data, function(res) {
    if (res === "true") {
     callback("load");
     setTimeout(function() {
      send("temp_get.txt", {}, function(res) {
       callback(res);
       localStorage.clear();
      });
     }, 15000);
    } else {
     callback(false);
    }
   });
  }

  function startLoad(name){
   id("m-text").innerHTML = "Start of update <br/>";
   loading(name,function(res){
    if(res==="load"){
     id("loader").classList.remove('hide');
     id("m-text").innerHTML += "Loading ... wait<br>";
    }else if (res){
     id("loader").classList.add('hide');
     id("start").classList.add('hide');
     id("m-text").innerHTML += res.replace(/\n/g, '<br />');
     id("close").innerHTML = "Done";
     id("reboot").classList.remove('hide');
    }else{
     id("m-text").innerHTML += "Loading error<br/>";
    }
   });
  }

  function update() {
   id("Modal").style.display = "block";
  }

  function mClose() {
   id('Modal').style.display = 'none';
   id("close").innerHTML = "Close";
   id("reboot").classList.add('hide');
   id("start").classList.remove('hide');
  }

  function reboot() {
   id("loader").classList.remove('hide');
   mClose();
   send("web_control.lua", {
    init: "reboot"
   }, function(res) {
    setTimeout(function() {
     location.href = "/";
    }, 10000);
   });
  }

  function logout() {
   document.cookie = "id=";
   location.href = '/login.html';
  }

 </script>
</body>

</html>
